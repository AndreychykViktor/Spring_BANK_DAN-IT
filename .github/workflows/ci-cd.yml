name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE: andreychykviktor/bank-app
  KUBERNETES_NAMESPACE: bank-system

jobs:
  # Build Docker image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: []
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
            type=sha,prefix=${{ github.ref_name }}-,format=short
      
      - name: Verify Dockerfile exists
        run: |
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ Dockerfile..."
          if [ -f "./backend/Dockerfile" ]; then
            echo "‚úÖ Dockerfile –∑–Ω–∞–π–¥–µ–Ω–æ: ./backend/Dockerfile"
            ls -lh ./backend/Dockerfile
          else
            echo "‚ùå Dockerfile –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ ./backend/Dockerfile"
            echo "üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π:"
            ls -la backend/ | head -20
            exit 1
          fi
      
      - name: List files in backend directory
        run: |
          echo "üìã –§–∞–π–ª–∏ –≤ backend/:"
          ls -la ./backend/ | head -20
          echo ""
          echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Dockerfile:"
          if [ -f "./backend/Dockerfile" ]; then
            echo "‚úÖ Dockerfile —ñ—Å–Ω—É—î"
            cat ./backend/Dockerfile | head -10
          else
            echo "‚ùå Dockerfile –ù–ï –∑–Ω–∞–π–¥–µ–Ω–æ!"
            exit 1
          fi
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max
      
      - name: Output image tags
        id: image-tags
        run: |
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ latest –¥–ª—è –ø—Ä–æ—Å—Ç—ñ—à–æ–≥–æ –¥–µ–ø–ª–æ—é
          IMAGE_TAG="latest"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.DOCKER_IMAGE }}:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Built image tag: ${IMAGE_TAG}"
          echo "üì¶ Full image: ${{ env.DOCKER_IMAGE }}:${IMAGE_TAG}"
          echo "üì¶ All tags from metadata: ${{ steps.meta.outputs.tags }}"

  # Deploy to Azure AKS
  deploy-azure:
    name: Deploy to Azure AKS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: 
      name: production-azure
      url: https://andreychyk-bank.duckdns.org
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client
      
      - name: Get image tag from build
        id: image-tag
        run: |
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ latest –¥–ª—è –ø—Ä–æ—Å—Ç—ñ—à–æ–≥–æ –¥–µ–ø–ª–æ—é
          IMAGE_TAG="latest"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.DOCKER_IMAGE }}:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Image tag: ${IMAGE_TAG}"
          echo "üì¶ Full image: ${{ env.DOCKER_IMAGE }}:${IMAGE_TAG}"
      
      - name: Configure kubectl for Azure
        id: kubeconfig
        run: |
          KUBECONFIG_PATH=""
          
          if [ -n "${{ secrets.KUBECONFIG_AZURE }}" ]; then
            echo "${{ secrets.KUBECONFIG_AZURE }}" | base64 -d > kubeconfig-azure.yaml
            KUBECONFIG_PATH="$(pwd)/kubeconfig-azure.yaml"
            echo "KUBECONFIG_PATH=${KUBECONFIG_PATH}" >> $GITHUB_OUTPUT
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG_AZURE"
          elif [ -n "${{ secrets.KUBECONFIG }}" ]; then
            echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
            KUBECONFIG_PATH="$(pwd)/kubeconfig.yaml"
            echo "KUBECONFIG_PATH=${KUBECONFIG_PATH}" >> $GITHUB_OUTPUT
            # –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç Azure —è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ
            if [ -n "${{ secrets.AZURE_KUBERNETES_CONTEXT }}" ]; then
              kubectl config use-context "${{ secrets.AZURE_KUBERNETES_CONTEXT }}" --kubeconfig="${KUBECONFIG_PATH}"
              echo "‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: ${{ secrets.AZURE_KUBERNETES_CONTEXT }}"
            else
              echo "‚ö†Ô∏è AZURE_KUBERNETES_CONTEXT –Ω–µ –≤–∫–∞–∑–∞–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ Azure –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
              # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–∞–π—Ç–∏ Azure –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ –Ω–∞–∑–≤–æ—é
              AZURE_CTX=$(kubectl config get-contexts -o name --kubeconfig="${KUBECONFIG_PATH}" | grep -i "andreychyk-bank-cluster" | grep -v eks | head -1 || echo "")
              if [ -n "$AZURE_CTX" ]; then
                kubectl config use-context "$AZURE_CTX" --kubeconfig="${KUBECONFIG_PATH}"
                echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: $AZURE_CTX"
              else
                echo "‚ö†Ô∏è Azure –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ –ø–µ—Ä—à–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π"
                FIRST_CTX=$(kubectl config get-contexts -o name --kubeconfig="${KUBECONFIG_PATH}" | head -1 || echo "")
                if [ -n "$FIRST_CTX" ]; then
                  kubectl config use-context "$FIRST_CTX" --kubeconfig="${KUBECONFIG_PATH}"
                  echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ø–µ—Ä—à–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: $FIRST_CTX"
                else
                  echo "‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É"
                  kubectl config get-contexts --kubeconfig="${KUBECONFIG_PATH}"
                  exit 1
                fi
              fi
            fi
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"
          else
            echo "‚ùå KUBECONFIG_AZURE –∞–±–æ KUBECONFIG secret –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
            echo "–î–æ–¥–∞–π—Ç–µ –æ–¥–∏–Ω –∑ —Ü–∏—Ö secrets –≤ GitHub:"
            echo "  - KUBECONFIG_AZURE (–æ–∫—Ä–µ–º–∏–π config –¥–ª—è Azure)"
            echo "  - KUBECONFIG (–∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π config) + AZURE_KUBERNETES_CONTEXT"
            exit 1
          fi
          
          # –í–∞–ª—ñ–¥–∞—Ü—ñ—è KUBECONFIG
          if [ -z "${KUBECONFIG_PATH}" ]; then
            echo "‚ùå KUBECONFIG_PATH –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ—Å–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"
            exit 1
          fi
          
          if [ ! -f "${KUBECONFIG_PATH}" ]; then
            echo "‚ùå KUBECONFIG —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ${KUBECONFIG_PATH}"
            exit 1
          fi
          
          echo "üìã KUBECONFIG_PATH: ${KUBECONFIG_PATH}"
          echo "üìã –ü–æ—Ç–æ—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:"
          kubectl config current-context --kubeconfig="${KUBECONFIG_PATH}" || {
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"
            exit 1
          }
          echo "üìã –î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∏:"
          kubectl config get-contexts --kubeconfig="${KUBECONFIG_PATH}"
          
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∫–ª–∞—Å—Ç–µ—Ä–æ–º
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∫–ª–∞—Å—Ç–µ—Ä–æ–º..."
          kubectl cluster-info --kubeconfig="${KUBECONFIG_PATH}" || {
            echo "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞, –∞–ª–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ..."
          }
      
      - name: Wait for Docker image to be available
        run: |
          IMAGE_TAG="${{ steps.image-tag.outputs.image_tag }}"
          FULL_IMAGE="${{ env.DOCKER_IMAGE }}:${IMAGE_TAG}"
          LATEST_IMAGE="${{ env.DOCKER_IMAGE }}:latest"
          
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –æ–±—Ä–∞–∑—É: ${FULL_IMAGE}"
          echo "‚è≥ –û—á—ñ–∫—É—î–º–æ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è push –æ–±—Ä–∞–∑—É..."
          sleep 10
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ–±—Ä–∞–∑ –¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ Docker Hub API
          echo "‚úÖ –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ –æ–±—Ä–∞–∑ –∑–∞–ª–∏—Ç–∏–π. –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –¥–µ–ø–ª–æ—é."
      
      - name: Deploy to Azure AKS
        env:
          KUBECONFIG: ${{ steps.kubeconfig.outputs.KUBECONFIG_PATH }}
        continue-on-error: false
        run: |
          IMAGE_TO_DEPLOY="${{ env.DOCKER_IMAGE }}:latest"
          
          echo "üöÄ –î–µ–ø–ª–æ–π –≤ Azure AKS..."
          echo "üì¶ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–±—Ä–∞–∑: ${IMAGE_TO_DEPLOY}"
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ deployment —ñ—Å–Ω—É—î
          if ! kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Deployment bank-app –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ namespace ${{ env.KUBERNETES_NAMESPACE }}"
            echo "‚ÑπÔ∏è Deployment –º–∞—î –±—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –≤—Ä—É—á–Ω—É –∞–±–æ —á–µ—Ä–µ–∑ kubectl apply"
            echo "‚úÖ Skipping deployment (deployment –Ω–µ —ñ—Å–Ω—É—î)"
            exit 0
          fi
          
          # –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
          CURRENT_IMAGE=$(kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
          echo "üìã –ü–æ—Ç–æ—á–Ω–∏–π –æ–±—Ä–∞–∑: ${CURRENT_IMAGE}"
          echo "üìã –ù–æ–≤–∏–π –æ–±—Ä–∞–∑: ${IMAGE_TO_DEPLOY}"
          
          # –û–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–∞–∑
          echo "üîÑ –û–Ω–æ–≤–ª—é—î–º–æ deployment..."
          if kubectl set image deployment/bank-app bank-app="${IMAGE_TO_DEPLOY}" -n ${{ env.KUBERNETES_NAMESPACE }}; then
            echo "‚úÖ –û–±—Ä–∞–∑ –æ–Ω–æ–≤–ª–µ–Ω–æ"
          else
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–±—Ä–∞–∑—É"
            exit 1
          fi
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ–±—Ä–∞–∑ –∑–º—ñ–Ω–∏–≤—Å—è
          NEW_IMAGE=$(kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
          echo "üìã –û–Ω–æ–≤–ª–µ–Ω–∏–π –æ–±—Ä–∞–∑: ${NEW_IMAGE}"
          
          # –ü—Ä–∏–º—É—Å–æ–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –¥–ª—è –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—É
          echo "üîÑ –ü—Ä–∏–º—É—Å–æ–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ deployment..."
          if kubectl rollout restart deployment/bank-app -n ${{ env.KUBERNETES_NAMESPACE }}; then
            echo "‚úÖ Deployment –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É deployment, –∞–ª–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ..."
          fi
      
      - name: Verify Azure deployment
        env:
          KUBECONFIG: ${{ steps.kubeconfig.outputs.KUBECONFIG_PATH }}
        continue-on-error: true
        run: |
          echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å deployment –≤ Azure..."
          if kubectl rollout status deployment/bank-app -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m; then
            echo "‚úÖ Deployment –≥–æ—Ç–æ–≤–∏–π"
          else
            echo "‚ö†Ô∏è Deployment –Ω–µ –≥–æ—Ç–æ–≤–∏–π –≤—á–∞—Å–Ω–æ, –∞–ª–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å..."
            kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} -l app=bank-app
            # –ù–µ –≤–∏—Ö–æ–¥–∏–º–æ –∑ –ø–æ–º–∏–ª–∫–æ—é, —â–æ–± –Ω–µ –ø–∞–¥–∞–≤ –≤–µ—Å—å pipeline
            exit 0
          fi
          
      - name: Get Azure deployment status
        env:
          KUBECONFIG: ${{ steps.kubeconfig.outputs.KUBECONFIG_PATH }}
        run: |
          echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥—ñ–≤ –≤ Azure:"
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} -l app=bank-app
          echo ""
          echo "üìã Deployment details:"
          kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""

  # Deploy to AWS EKS
  deploy-aws:
    name: Deploy to AWS EKS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && (secrets.AWS_ACCESS_KEY_ID != '' || secrets.KUBECONFIG_AWS != '' || secrets.KUBECONFIG != '')
    environment: 
      name: production-aws
      url: https://andreychyk-bank.duckdns.org
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client
      
      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install
          aws --version
      
      - name: Configure AWS credentials
        if: secrets.AWS_ACCESS_KEY_ID != ''
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-north-1' }}
      
      - name: Get image tag from build
        id: image-tag
        run: |
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ latest –¥–ª—è –ø—Ä–æ—Å—Ç—ñ—à–æ–≥–æ –¥–µ–ø–ª–æ—é
          IMAGE_TAG="latest"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.DOCKER_IMAGE }}:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Image tag: ${IMAGE_TAG}"
          echo "üì¶ Full image: ${{ env.DOCKER_IMAGE }}:${IMAGE_TAG}"
      
      - name: Configure kubectl for AWS
        id: kubeconfig
        run: |
          KUBECONFIG_PATH=""
          
          if [ -n "${{ secrets.KUBECONFIG_AWS }}" ]; then
            echo "${{ secrets.KUBECONFIG_AWS }}" | base64 -d > kubeconfig-aws.yaml
            KUBECONFIG_PATH="$(pwd)/kubeconfig-aws.yaml"
            echo "KUBECONFIG_PATH=${KUBECONFIG_PATH}" >> $GITHUB_OUTPUT
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG_AWS"
          elif [ -n "${{ secrets.KUBECONFIG }}" ]; then
            echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
            KUBECONFIG_PATH="$(pwd)/kubeconfig.yaml"
            echo "KUBECONFIG_PATH=${KUBECONFIG_PATH}" >> $GITHUB_OUTPUT
            # –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç AWS —è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ
            if [ -n "${{ secrets.AWS_KUBERNETES_CONTEXT }}" ]; then
              kubectl config use-context "${{ secrets.AWS_KUBERNETES_CONTEXT }}" --kubeconfig="${KUBECONFIG_PATH}"
              echo "‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: ${{ secrets.AWS_KUBERNETES_CONTEXT }}"
            else
              echo "‚ö†Ô∏è AWS_KUBERNETES_CONTEXT –Ω–µ –≤–∫–∞–∑–∞–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ AWS –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
              # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–∞–π—Ç–∏ AWS –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ –Ω–∞–∑–≤–æ—é
              AWS_CTX=$(kubectl config get-contexts -o name --kubeconfig="${KUBECONFIG_PATH}" | grep -i eks | head -1 || echo "")
              if [ -n "$AWS_CTX" ]; then
                kubectl config use-context "$AWS_CTX" --kubeconfig="${KUBECONFIG_PATH}"
                echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: $AWS_CTX"
              else
                echo "‚ö†Ô∏è AWS –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ –ø–µ—Ä—à–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π"
                FIRST_CTX=$(kubectl config get-contexts -o name --kubeconfig="${KUBECONFIG_PATH}" | head -1 || echo "")
                if [ -n "$FIRST_CTX" ]; then
                  kubectl config use-context "$FIRST_CTX" --kubeconfig="${KUBECONFIG_PATH}"
                  echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ø–µ—Ä—à–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: $FIRST_CTX"
                else
                  echo "‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É"
                  kubectl config get-contexts --kubeconfig="${KUBECONFIG_PATH}"
                  exit 1
                fi
              fi
            fi
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"
          else
            # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ credentials –∑ AWS CLI (—è–∫—â–æ AWS credentials –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ)
            if [ -n "${{ secrets.AWS_EKS_CLUSTER_NAME }}" ] && [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
              echo "üîÑ –û—Ç—Ä–∏–º–∞–Ω–Ω—è credentials —á–µ—Ä–µ–∑ AWS CLI..."
              aws eks update-kubeconfig --name ${{ secrets.AWS_EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION || 'eu-north-1' }}
              KUBECONFIG_PATH="${HOME}/.kube/config"
              echo "KUBECONFIG_PATH=${KUBECONFIG_PATH}" >> $GITHUB_OUTPUT
              echo "‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ credentials —á–µ—Ä–µ–∑ AWS CLI"
            else
              echo "‚ùå KUBECONFIG_AWS, KUBECONFIG –∞–±–æ AWS_EKS_CLUSTER_NAME –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
              echo "–î–æ–¥–∞–π—Ç–µ –æ–¥–∏–Ω –∑ —Ü–∏—Ö secrets –≤ GitHub:"
              echo "  - KUBECONFIG_AWS (–æ–∫—Ä–µ–º–∏–π config –¥–ª—è AWS)"
              echo "  - KUBECONFIG (–∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π config) + AWS_KUBERNETES_CONTEXT"
              echo "  - AWS_EKS_CLUSTER_NAME + AWS_REGION (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è)"
              exit 1
            fi
          fi
          
          # –í–∞–ª—ñ–¥–∞—Ü—ñ—è KUBECONFIG
          if [ -z "${KUBECONFIG_PATH}" ]; then
            # –°–ø—Ä–æ–±—É—î–º–æ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –∑ outputs
            KUBECONFIG_PATH="${{ steps.kubeconfig.outputs.KUBECONFIG_PATH }}"
            if [ -z "${KUBECONFIG_PATH}" ]; then
              echo "‚ùå KUBECONFIG_PATH –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ—Å–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"
              exit 1
            fi
          fi
          
          if [ ! -f "${KUBECONFIG_PATH}" ]; then
            echo "‚ùå KUBECONFIG —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ${KUBECONFIG_PATH}"
            exit 1
          fi
          
          echo "üìã KUBECONFIG_PATH: ${KUBECONFIG_PATH}"
          echo "üìã –ü–æ—Ç–æ—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:"
          kubectl config current-context --kubeconfig="${KUBECONFIG_PATH}" || {
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"
            exit 1
          }
          echo "üìã –î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∏:"
          kubectl config get-contexts --kubeconfig="${KUBECONFIG_PATH}"
          
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∫–ª–∞—Å—Ç–µ—Ä–æ–º
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∫–ª–∞—Å—Ç–µ—Ä–æ–º..."
          kubectl cluster-info --kubeconfig="${KUBECONFIG_PATH}" || {
            echo "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞, –∞–ª–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ..."
          }
      
      - name: Deploy to AWS EKS
        env:
          KUBECONFIG: ${{ steps.kubeconfig.outputs.KUBECONFIG_PATH }}
        continue-on-error: true
        run: |
          IMAGE_TO_DEPLOY="${{ env.DOCKER_IMAGE }}:latest"
          
          echo "üöÄ –î–µ–ø–ª–æ–π –≤ AWS EKS..."
          echo "üì¶ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–±—Ä–∞–∑: ${IMAGE_TO_DEPLOY}"
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ deployment —ñ—Å–Ω—É—î
          if ! kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Deployment bank-app –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ namespace ${{ env.KUBERNETES_NAMESPACE }}"
            echo "‚ÑπÔ∏è Deployment –º–∞—î –±—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –≤—Ä—É—á–Ω—É –∞–±–æ —á–µ—Ä–µ–∑ kubectl apply"
            echo "‚úÖ Skipping deployment (deployment –Ω–µ —ñ—Å–Ω—É—î)"
            exit 0
          fi
          
          # –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
          CURRENT_IMAGE=$(kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
          echo "üìã –ü–æ—Ç–æ—á–Ω–∏–π –æ–±—Ä–∞–∑: ${CURRENT_IMAGE}"
          echo "üìã –ù–æ–≤–∏–π –æ–±—Ä–∞–∑: ${IMAGE_TO_DEPLOY}"
          
          # –û–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–∞–∑
          echo "üîÑ –û–Ω–æ–≤–ª—é—î–º–æ deployment..."
          if kubectl set image deployment/bank-app bank-app="${IMAGE_TO_DEPLOY}" -n ${{ env.KUBERNETES_NAMESPACE }}; then
            echo "‚úÖ –û–±—Ä–∞–∑ –æ–Ω–æ–≤–ª–µ–Ω–æ"
          else
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–±—Ä–∞–∑—É"
            exit 1
          fi
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ–±—Ä–∞–∑ –∑–º—ñ–Ω–∏–≤—Å—è
          NEW_IMAGE=$(kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
          echo "üìã –û–Ω–æ–≤–ª–µ–Ω–∏–π –æ–±—Ä–∞–∑: ${NEW_IMAGE}"
          
          # –ü—Ä–∏–º—É—Å–æ–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –¥–ª—è –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—É
          echo "üîÑ –ü—Ä–∏–º—É—Å–æ–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ deployment..."
          if kubectl rollout restart deployment/bank-app -n ${{ env.KUBERNETES_NAMESPACE }}; then
            echo "‚úÖ Deployment –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É deployment, –∞–ª–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ..."
          fi
      
      - name: Verify AWS deployment
        env:
          KUBECONFIG: ${{ steps.kubeconfig.outputs.KUBECONFIG_PATH }}
        continue-on-error: true
        run: |
          echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å deployment –≤ AWS..."
          if kubectl rollout status deployment/bank-app -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m; then
            echo "‚úÖ Deployment –≥–æ—Ç–æ–≤–∏–π"
          else
            echo "‚ö†Ô∏è Deployment –Ω–µ –≥–æ—Ç–æ–≤–∏–π –≤—á–∞—Å–Ω–æ, –∞–ª–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å..."
            kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} -l app=bank-app
            # –ù–µ –≤–∏—Ö–æ–¥–∏–º–æ –∑ –ø–æ–º–∏–ª–∫–æ—é, —â–æ–± –Ω–µ –ø–∞–¥–∞–≤ –≤–µ—Å—å pipeline
            exit 0
          fi
      
      - name: Get AWS deployment status
        env:
          KUBECONFIG: ${{ steps.kubeconfig.outputs.KUBECONFIG_PATH }}
        run: |
          echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥—ñ–≤ –≤ AWS:"
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} -l app=bank-app
          echo ""
          echo "üìã Deployment details:"
          kubectl get deployment bank-app -n ${{ env.KUBERNETES_NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""

  # Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          continue-on-error: true
      
      - name: Upload Trivy results to GitHub Security
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

