name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE: andreychykviktor/bank-app
  KUBERNETES_NAMESPACE: bank-system

jobs:
  # Build Docker image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: []
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  # Deploy to Azure AKS
  deploy-azure:
    name: Deploy to Azure AKS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: 
      name: production-azure
      url: https://andreychyk-bank.duckdns.org
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: kubernetes/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl for Azure
        run: |
          if [ -n "${{ secrets.KUBECONFIG_AZURE }}" ]; then
            echo "${{ secrets.KUBECONFIG_AZURE }}" | base64 -d > kubeconfig-azure.yaml
            export KUBECONFIG=kubeconfig-azure.yaml
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG_AZURE"
          elif [ -n "${{ secrets.KUBECONFIG }}" ]; then
            echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
            export KUBECONFIG=kubeconfig.yaml
            # –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç Azure —è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ
            if [ -n "${{ secrets.AZURE_KUBERNETES_CONTEXT }}" ]; then
              kubectl config use-context ${{ secrets.AZURE_KUBERNETES_CONTEXT }}
              echo "‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: ${{ secrets.AZURE_KUBERNETES_CONTEXT }}"
            else
              echo "‚ö†Ô∏è AZURE_KUBERNETES_CONTEXT –Ω–µ –≤–∫–∞–∑–∞–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ Azure –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
              # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–∞–π—Ç–∏ Azure –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ –Ω–∞–∑–≤–æ—é
              AZURE_CTX=$(kubectl config get-contexts -o name | grep -i "andreychyk-bank-cluster" | grep -v eks || echo "")
              if [ -n "$AZURE_CTX" ]; then
                kubectl config use-context "$AZURE_CTX"
                echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: $AZURE_CTX"
              else
                echo "‚ùå Azure –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
                kubectl config get-contexts
                exit 1
              fi
            fi
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"
          else
            echo "‚ùå KUBECONFIG_AZURE –∞–±–æ KUBECONFIG secret –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
            echo "–î–æ–¥–∞–π—Ç–µ –æ–¥–∏–Ω –∑ —Ü–∏—Ö secrets –≤ GitHub:"
            echo "  - KUBECONFIG_AZURE (–æ–∫—Ä–µ–º–∏–π config –¥–ª—è Azure)"
            echo "  - KUBECONFIG (–∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π config) + AZURE_KUBERNETES_CONTEXT"
            exit 1
          fi
          echo "üìã –ü–æ—Ç–æ—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:"
          kubectl config current-context
          echo "üìã –î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∏:"
          kubectl config get-contexts
      
      - name: Deploy to Azure AKS
        run: |
          export KUBECONFIG=${KUBECONFIG:-kubeconfig-azure.yaml}
          export IMAGE_TAG=${{ github.sha }}
          
          echo "üöÄ –î–µ–ø–ª–æ–π –≤ Azure AKS..."
          kubectl set image deployment/bank-app bank-app=${{ env.DOCKER_IMAGE }}:main-${{ github.sha }} -n ${{ env.KUBERNETES_NAMESPACE }}
      
      - name: Verify Azure deployment
        run: |
          export KUBECONFIG=${KUBECONFIG:-kubeconfig-azure.yaml}
          echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å deployment –≤ Azure..."
          kubectl rollout status deployment/bank-app -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m
          
      - name: Get Azure deployment status
        run: |
          export KUBECONFIG=${KUBECONFIG:-kubeconfig-azure.yaml}
          echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥—ñ–≤ –≤ Azure:"
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} -l app=bank-app

  # Deploy to AWS EKS
  deploy-aws:
    name: Deploy to AWS EKS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: 
      name: production-aws
      url: https://andreychyk-bank.duckdns.org
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: kubernetes/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-north-1' }}
      
      - name: Configure kubectl for AWS
        run: |
          if [ -n "${{ secrets.KUBECONFIG_AWS }}" ]; then
            echo "${{ secrets.KUBECONFIG_AWS }}" | base64 -d > kubeconfig-aws.yaml
            export KUBECONFIG=kubeconfig-aws.yaml
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG_AWS"
          elif [ -n "${{ secrets.KUBECONFIG }}" ]; then
            echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
            export KUBECONFIG=kubeconfig.yaml
            # –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç AWS —è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ
            if [ -n "${{ secrets.AWS_KUBERNETES_CONTEXT }}" ]; then
              kubectl config use-context ${{ secrets.AWS_KUBERNETES_CONTEXT }}
              echo "‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: ${{ secrets.AWS_KUBERNETES_CONTEXT }}"
            else
              echo "‚ö†Ô∏è AWS_KUBERNETES_CONTEXT –Ω–µ –≤–∫–∞–∑–∞–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ AWS –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
              # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–∞–π—Ç–∏ AWS –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ –Ω–∞–∑–≤–æ—é
              AWS_CTX=$(kubectl config get-contexts -o name | grep -i eks || echo "")
              if [ -n "$AWS_CTX" ]; then
                kubectl config use-context "$AWS_CTX"
                echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç: $AWS_CTX"
              else
                echo "‚ùå AWS –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
                kubectl config get-contexts
                exit 1
              fi
            fi
            echo "‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ KUBECONFIG –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"
          else
            # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ credentials –∑ AWS CLI (—è–∫—â–æ AWS credentials –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ)
            if [ -n "${{ secrets.AWS_EKS_CLUSTER_NAME }}" ] && [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
              echo "üîÑ –û—Ç—Ä–∏–º–∞–Ω–Ω—è credentials —á–µ—Ä–µ–∑ AWS CLI..."
              aws eks update-kubeconfig --name ${{ secrets.AWS_EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION || 'eu-north-1' }}
              echo "‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ credentials —á–µ—Ä–µ–∑ AWS CLI"
            else
              echo "‚ùå KUBECONFIG_AWS, KUBECONFIG –∞–±–æ AWS_EKS_CLUSTER_NAME –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
              echo "–î–æ–¥–∞–π—Ç–µ –æ–¥–∏–Ω –∑ —Ü–∏—Ö secrets –≤ GitHub:"
              echo "  - KUBECONFIG_AWS (–æ–∫—Ä–µ–º–∏–π config –¥–ª—è AWS)"
              echo "  - KUBECONFIG (–∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π config) + AWS_KUBERNETES_CONTEXT"
              echo "  - AWS_EKS_CLUSTER_NAME + AWS_REGION (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è)"
              exit 1
            fi
          fi
          echo "üìã –ü–æ—Ç–æ—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:"
          kubectl config current-context
          echo "üìã –î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∏:"
          kubectl config get-contexts
      
      - name: Deploy to AWS EKS
        run: |
          export KUBECONFIG=${KUBECONFIG:-kubeconfig-aws.yaml}
          export IMAGE_TAG=${{ github.sha }}
          
          echo "üöÄ –î–µ–ø–ª–æ–π –≤ AWS EKS..."
          kubectl set image deployment/bank-app bank-app=${{ env.DOCKER_IMAGE }}:main-${{ github.sha }} -n ${{ env.KUBERNETES_NAMESPACE }}
      
      - name: Verify AWS deployment
        run: |
          export KUBECONFIG=${KUBECONFIG:-kubeconfig-aws.yaml}
          echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å deployment –≤ AWS..."
          kubectl rollout status deployment/bank-app -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m
      
      - name: Get AWS deployment status
        run: |
          export KUBECONFIG=${KUBECONFIG:-kubeconfig-aws.yaml}
          echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥—ñ–≤ –≤ AWS:"
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} -l app=bank-app

  # Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:main-${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

